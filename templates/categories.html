{% extends "base.html" %}
{% block content %}
<div class="page-head">
  <div>
    <h1>Categories</h1>
    <p>Manage categories, subcategories, measurements, icons, and units.</p>
  </div>
</div>

<div class="tabs" style="margin-bottom: 1rem;">
  <button type="button" class="tab-btn active" data-tab="cat-tab">Categories</button>
  <button type="button" class="tab-btn" data-tab="sub-tab">Subcategories</button>
  <button type="button" class="tab-btn" data-tab="field-tab">Measurement fields</button>
  <button type="button" class="tab-btn" data-tab="icon-tab">Requirement icons</button>
  <button type="button" class="tab-btn" data-tab="uom-tab">UOM</button>
</div>

<div class="tab-panel active" data-panel="cat-tab">
  <section class="card">
    <h3>Categories</h3>
    <form class="stack" method="post">
      <input type="hidden" name="action" value="add_category" />
      <label>
        Category name
        <input type="text" name="category_name" required />
      </label>
      <label>
        Measurement type
        <select name="measurement_type">
          <option>Shirt</option>
          <option>Pant</option>
        </select>
      </label>
      <button class="btn primary" type="submit">Add category</button>
    </form>

    <div class="table-wrap" style="--table-cols: 1.6fr 1fr 0.6fr; margin-top: 1rem;">
      <div class="table">
        <div class="table-row table-head">
          <div>Category</div>
          <div>Measurement</div>
          <div></div>
        </div>
        {% for c in categories %}
        <div class="table-row">
          <div>{{ c.name }}</div>
          <div>{{ c.measurement_type }}</div>
          <div>
            <form method="post">
              <input type="hidden" name="action" value="delete_category" />
              <input type="hidden" name="category_id" value="{{ c.id }}" />
              <button class="btn ghost" type="submit">Delete</button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="table-row">
          <div class="muted" style="grid-column: 1 / -1; text-align:center;">No categories yet</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<div class="tab-panel" data-panel="sub-tab">
  <section class="card">
    <h3>Subcategories</h3>
    <form class="stack" method="post">
      <input type="hidden" name="action" value="add_subcategory" />
      <label>
        Category
        <select name="subcategory_category_id" required>
          {% for c in categories %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Subcategory name
        <input type="text" name="subcategory_name" required />
      </label>
      <button class="btn primary" type="submit">Add subcategory</button>
    </form>

    <div class="table-wrap" style="--table-cols: 1.2fr 1.4fr 0.6fr; margin-top: 1rem;">
      <div class="table">
        <div class="table-row table-head">
          <div>Category</div>
          <div>Subcategory</div>
          <div></div>
        </div>
        {% for s in subcategories %}
        <div class="table-row">
          <div>{{ s.category_name }}</div>
          <div>{{ s.name }}</div>
          <div>
            <form method="post">
              <input type="hidden" name="action" value="delete_subcategory" />
              <input type="hidden" name="subcategory_id" value="{{ s.id }}" />
              <button class="btn ghost" type="submit">Delete</button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="table-row">
          <div class="muted" style="grid-column: 1 / -1; text-align:center;">No subcategories yet</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<div class="tab-panel" data-panel="field-tab">
  <section class="card">
    <h3>Measurement fields</h3>
    <form class="stack" method="post">
      <input type="hidden" name="action" value="save_fields" />
      <label>
        Subcategory
        <select name="fields_subcategory_id" id="fields-subcategory" required>
          {% for s in subcategories %}
          <option value="{{ s.id }}">{{ s.category_name }} - {{ s.name }}</option>
          {% endfor %}
        </select>
      </label>
      <div id="fields-list" class="stack"></div>
      <button type="button" class="btn ghost" id="add-field-row">+ Add field</button>
      <button class="btn primary" type="submit">Save fields</button>
    </form>
  </section>
</div>

<div class="tab-panel" data-panel="icon-tab">
  <section class="card">
    <h3>Requirement icons</h3>
    <form class="stack" method="post" enctype="multipart/form-data">
      <input type="hidden" name="action" value="add_requirement" />
      <label>
        Name
        <input type="text" name="requirement_name" required />
      </label>
      <label>
        Icon image
        <input type="file" name="requirement_icon" accept="image/*" required />
      </label>
      <button class="btn primary" type="submit">Add icon</button>
    </form>

    <div class="table-wrap" style="--table-cols: 0.6fr 1.6fr 0.6fr; margin-top: 1rem;">
      <div class="table">
        <div class="table-row table-head">
          <div>Icon</div>
          <div>Name</div>
          <div></div>
        </div>
        {% for r in requirement_icons %}
        <div class="table-row">
          <div>
            <img src="{{ url_for('static', filename='req_icons/' ~ r.filename) }}" alt="{{ r.name }}" style="width:32px;height:32px;border-radius:8px;object-fit:cover;" />
          </div>
          <div>{{ r.name }}</div>
          <div>
            <form method="post">
              <input type="hidden" name="action" value="delete_requirement" />
              <input type="hidden" name="requirement_id" value="{{ r.id }}" />
              <button class="btn ghost" type="submit">Delete</button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="table-row">
          <div class="muted" style="grid-column: 1 / -1; text-align:center;">No icons yet</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>

<div class="tab-panel" data-panel="uom-tab">
  <section class="card">
    <h3>UOM</h3>
    <form class="stack" method="post">
      <input type="hidden" name="action" value="add_uom" />
      <label>
        UOM name
        <input type="text" name="uom_name" required />
      </label>
      <button class="btn primary" type="submit">Add UOM</button>
    </form>

    <div class="table-wrap" style="--table-cols: 1.6fr 0.6fr; margin-top: 1rem;">
      <div class="table">
        <div class="table-row table-head">
          <div>UOM</div>
          <div></div>
        </div>
        {% for u in uoms %}
        <div class="table-row">
          <div>{{ u.name }}</div>
          <div>
            <form method="post">
              <input type="hidden" name="action" value="delete_uom" />
              <input type="hidden" name="uom_id" value="{{ u.id }}" />
              <button class="btn ghost" type="submit">Delete</button>
            </form>
          </div>
        </div>
        {% else %}
        <div class="table-row">
          <div class="muted" style="grid-column: 1 / -1; text-align:center;">No UOMs yet</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
</div>
<script>
  const fieldMap = {{ measurement_field_map | tojson }};
  const fieldSelect = document.getElementById("fields-subcategory");
  const fieldsList = document.getElementById("fields-list");
  const addFieldBtn = document.getElementById("add-field-row");

  function createFieldRow(label = "", key = "") {
    const row = document.createElement("div");
    row.className = "table-row";
    row.style.gridTemplateColumns = "1fr 0.2fr";
    row.innerHTML = `
      <div>
        <input type="hidden" name="field_key" value="${key}" />
        <input type="text" name="field_label" placeholder="Field name" value="${label}" />
      </div>
      <div>
        <button type="button" class="btn ghost field-delete" aria-label="Remove field">×</button>
      </div>
    `;
    return row;
  }

  function renderFields() {
    if (!fieldsList) return;
    fieldsList.innerHTML = "";
    const subId = fieldSelect ? fieldSelect.value : "";
    const fields = subId && fieldMap[subId] ? fieldMap[subId] : [];
    if (!fields.length) {
      fieldsList.appendChild(createFieldRow());
      return;
    }
    fields.forEach((field) => {
      fieldsList.appendChild(createFieldRow(field.label, field.key));
    });
  }

  if (addFieldBtn) {
    addFieldBtn.addEventListener("click", () => {
      fieldsList.appendChild(createFieldRow());
    });
  }

  document.addEventListener("click", (event) => {
    const btn = event.target.closest(".field-delete");
    if (btn) {
      const row = btn.closest(".table-row");
      if (row) {
        row.remove();
      }
    }
  });

  if (fieldSelect) {
    fieldSelect.addEventListener("change", renderFields);
    renderFields();
  }
</script>
{% endblock %}
